<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Test</title>
</head>
<body>
    <h2>WebRTC Test Client</h2>
    <div id="status">Disconnected</div>
    <button id="connect">Connect</button>
    <div>
        <input type="text" id="message" placeholder="Type a message">
        <button id="send">Send</button>
    </div>
    <div id="messages"></div>

    <script>
        let pc;
        let dc;

        const connect = async () => {
            // Create RTCPeerConnection
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });

            // Create Data Channel
            dc = pc.createDataChannel('data');
            dc.onmessage = e => {
                const messages = document.getElementById('messages');
                messages.innerHTML += `<div>Received: ${e.data}</div>`;
            };
            dc.onopen = () => {
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('connect').disabled = true;
            };

            // Create offer
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Wait for ICE gathering to complete
            await new Promise(resolve => {
                if (pc.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    pc.addEventListener('icegatheringstatechange', () => {
                        if (pc.iceGatheringState === 'complete') {
                            resolve();
                        }
                    });
                }
            });

            // Send offer using WebRTC endpoint
            const response = await fetch('/session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/sdp',
                },
                body: JSON.stringify(pc.localDescription)
            });

            if (!response.ok) {
                throw new Error('Failed to connect');
            }

            // Get and set remote description
            const answer = await response.json();
            await pc.setRemoteDescription(answer);
        };

        // Event listeners
        document.getElementById('connect').onclick = () => {
            connect().catch(err => {
                console.error('Connection failed:', err);
                document.getElementById('status').textContent = 'Connection failed';
            });
        };
        
        document.getElementById('send').onclick = () => {
            const input = document.getElementById('message');
            if (dc && dc.readyState === 'open') {
                dc.send(input.value);
                const messages = document.getElementById('messages');
                messages.innerHTML += `<div>Sent: ${input.value}</div>`;
                input.value = '';
            }
        };
    </script>
</body>
</html> 